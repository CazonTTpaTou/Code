WITH
T1 AS 
(
SELECT SNC_DATE, SNC_HEURE, SNC_BILLET, SNC_TARIF, SNC_BILLET * SNC_TARIF AS CA_SEANCE,
       SUM(SNC_BILLET * SNC_TARIF) 
          OVER(PARTITION BY SNC_DATE) AS CA_JOUR,
       SUM(SNC_BILLET * SNC_TARIF) 
          OVER(PARTITION BY YEAR(SNC_DATE), DATEPART(isowk, SNC_DATE)) 
             AS CA_SEMAINE,
       SUM(SNC_BILLET * SNC_TARIF) 
          OVER(PARTITION BY YEAR(SNC_DATE), MONTH(SNC_DATE)) 
             AS CA_MOIS
FROM   T_SEANCE_SNC
),
T2 AS
(
SELECT SNC_DATE, SNC_HEURE, SNC_BILLET, SNC_TARIF, CA_SEANCE, CA_JOUR, CA_SEMAINE, CA_MOIS, 
       AVG(CA_JOUR) OVER() AS CA_MOYEN_JOUR,
       AVG(CA_SEMAINE) OVER() AS CA_MOYEN_SEMAINE,
       AVG(CA_MOIS) OVER() AS CA_MOYEN_MOIS,
       ROW_NUMBER() OVER(ORDER BY CA_JOUR) AS CA_JOUR_ORDRE,
       ROW_NUMBER() OVER(ORDER BY CA_SEMAINE) AS CA_SEMAINE_ORDRE,
       ROW_NUMBER() OVER(ORDER BY CA_MOIS) AS CA_MOIS_ORDRE,
       COUNT(*) OVER() AS N
FROM   T1       
)
SELECT SNC_DATE, SNC_HEURE, SNC_BILLET, SNC_TARIF, CA_SEANCE, CA_JOUR, CA_SEMAINE, CA_MOIS,
       CA_MOYEN_JOUR, CA_MOYEN_SEMAINE, CA_MOYEN_MOIS,
       (SELECT AVG(CA_JOUR)
        FROM   T2
        WHERE  CA_JOUR_ORDRE BETWEEN FLOOR((N -0.5) / 2) + 1 
                                 AND CEILING((N + 0.5) / 2)) 
          AS CA_MEDIAN_JOUR,
       (SELECT AVG(CA_SEMAINE)
        FROM   T2
        WHERE  CA_SEMAINE_ORDRE BETWEEN FLOOR((N -0.5) / 2) + 1 
                                 AND CEILING((N + 0.5) / 2)) 
          AS CA_MEDIAN_SEMAINE,
       (SELECT AVG(CA_MOIS)
        FROM   T2
        WHERE  CA_MOIS_ORDRE BETWEEN FLOOR((N -0.5) / 2) + 1 
                                 AND CEILING((N + 0.5) / 2)) 
          AS CA_MEDIAN_MOIS
FROM   T2            


